<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MD to Word Converter</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e40af',
            secondary: '#3b82f6',
            accent: '#60a5fa',
            light: '#eff6ff',
            dark: '#1e3a8a'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'custom': '0 4px 20px 0 rgba(0, 0, 0, 0.1)',
            'hover': '0 10px 25px 0 rgba(0, 0, 0, 0.15)',
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .transition-custom {
        transition: all 0.3s ease;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .bg-gradient {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      }
    }
  </style>
  
  <!-- Custom Styles -->
  <style>
    .dropzone.active {
      border-color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.1);
    }
    
    .file-item {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .btn {
      transition: all 0.2s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .template-option.selected {
      border-color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.1);
    }
    
    .progress-bar {
      transition: width 0.3s ease;
    }
    
    /* 新增样式：区分文件类型 */
    .file-item.folder {
      border-left: 3px solid #f59e0b;
    }
    
    .file-item.markdown {
      border-left: 3px solid #3b82f6;
    }
    
    .file-item.image {
      border-left: 3px solid #10b981;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient text-white shadow-md">
    <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row items-center justify-between">
      <div class="flex items-center mb-4 md:mb-0">
        <i class="fa fa-file-text-o text-3xl mr-3"></i>
        <h1 class="text-2xl font-bold">MD to Word Converter</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/20 transition-custom">
          <i class="fa fa-moon-o"></i>
        </button>
        <button id="help-btn" class="p-2 rounded-full hover:bg-white/20 transition-custom">
          <i class="fa fa-question-circle"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Upload Area -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-custom p-6 mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Upload Markdown Files</h2>
          
          <!-- Dropzone -->
          <div id="dropzone" class="dropzone border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-secondary transition-custom">
            <div class="flex flex-col items-center justify-center">
              <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
              <p class="text-gray-600 mb-2">Drag & drop your Markdown files or folders here</p>
              <p class="text-gray-500 text-sm mb-4">or</p>
              <div class="flex flex-col sm:flex-row gap-3">
                <label class="btn bg-secondary hover:bg-primary text-white px-6 py-2 rounded-lg cursor-pointer">
                  <span>Choose Files</span>
                  <input type="file" id="file-input" class="hidden" accept=".md,.markdown,.txt" multiple>
                </label>
                <label class="btn bg-accent hover:bg-secondary text-white px-6 py-2 rounded-lg cursor-pointer">
                  <span>Choose Folder</span>
                  <input type="file" id="folder-input" class="hidden" webkitdirectory directory multiple>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Uploaded Files List -->
          <div id="files-container" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Uploaded Files</h3>
            <ul id="files-list" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hide"></ul>
          </div>
        </div>
        
        <!-- Conversion Options -->
        <div class="bg-white rounded-xl shadow-custom p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Conversion Options</h2>
          
          <!-- Template Selection -->
          <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2">Document Template</label>
            <div class="grid grid-cols-2 gap-3">
              <div class="template-option selected border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-secondary transition-custom">
                <div class="flex items-center">
                  <div class="w-10 h-10 bg-light rounded flex items-center justify-center mr-3">
                    <i class="fa fa-file-text-o text-secondary"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-800">Standard</p>
                    <p class="text-xs text-gray-500">Clean & simple</p>
                  </div>
                </div>
              </div>
              <div class="template-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-secondary transition-custom">
                <div class="flex items-center">
                  <div class="w-10 h-10 bg-light rounded flex items-center justify-center mr-3">
                    <i class="fa fa-file-text text-secondary"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-800">Professional</p>
                    <p class="text-xs text-gray-500">Formal styling</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Format Options -->
          <div class="mb-6">
            <label class="block text-gray-700 font-medium mb-2">Format Options</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" class="form-checkbox h-5 w-5 text-secondary" checked>
                <span class="ml-2 text-gray-700">Preserve Markdown formatting</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="form-checkbox h-5 w-5 text-secondary" checked>
                <span class="ml-2 text-gray-700">Include table of contents</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" class="form-checkbox h-5 w-5 text-secondary" checked>
                <span class="ml-2 text-gray-700">Embed images</span>
              </label>
            </div>
          </div>
          
          <!-- Convert Button -->
          <button id="convert-btn" class="btn w-full bg-primary hover:bg-dark text-white py-3 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
            <i class="fa fa-magic mr-2"></i> Convert to Word
          </button>
        </div>
      </div>
      
      <!-- Right Column - Preview & Results -->
      <div class="lg:col-span-2">
        <!-- Preview Area -->
        <div class="bg-white rounded-xl shadow-custom p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Preview</h2>
            <div class="flex space-x-2">
              <button id="editor-view-btn" class="px-3 py-1 rounded text-gray-600 hover:bg-light transition-custom">Editor</button>
              <button id="markdown-view-btn" class="px-3 py-1 rounded bg-light text-secondary font-medium">Markdown</button>
              <button id="html-view-btn" class="px-3 py-1 rounded text-gray-600 hover:bg-light transition-custom">HTML</button>
            </div>
          </div>
          
          <!-- Preview Tabs -->
          <div id="preview-container" class="border border-gray-200 rounded-lg min-h-[500px]">
            
            <!-- Markdown Editor (Hidden by default) -->
            <div id="markdown-editor" class="p-6 overflow-hidden hidden h-full" style="min-height: 500px;">
              <textarea id="md-editor-textarea" class="w-full h-full p-6 border-0 focus:ring-0 resize-none font-mono text-sm" placeholder="Enter your Markdown content here..."></textarea>
            </div>
            
            <!-- Markdown Preview -->
            <div id="markdown-preview" class="p-6 overflow-auto" style="min-height: 500px;">
              <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                  <i class="fa fa-file-text-o text-4xl mb-3"></i>
                  <p>Upload a file or use the editor to see preview</p>
                </div>
              </div>
            </div>
            
            <!-- HTML Preview (Hidden by default) -->
            <div id="html-preview" class="p-6 overflow-auto hidden" style="min-height: 500px;">
              <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                  <i class="fa fa-code text-4xl mb-3"></i>
                  <p>Upload a file or use the editor to see HTML preview</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Conversion Results -->
        <div id="results-container" class="bg-white rounded-xl shadow-custom p-6 hidden">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Conversion Results</h2>
          
          <!-- Progress Bar (Hidden by default) -->
          <div id="progress-container" class="mb-6 hidden">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-medium text-gray-700">Converting...</span>
              <span id="progress-percentage" class="text-sm font-medium text-gray-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progress-bar" class="bg-secondary h-2.5 rounded-full progress-bar" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- Results List -->
          <div id="results-list" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <h3 class="text-lg font-semibold flex items-center">
            <i class="fa fa-file-text-o mr-2"></i> MD to Word Converter
          </h3>
          <p class="text-gray-400 text-sm mt-1">A simple tool to convert Markdown files to Word documents</p>
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-gray-400 hover:text-white transition-custom">
            <i class="fa fa-github text-xl"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-custom">
            <i class="fa fa-twitter text-xl"></i>
          </a>
          <a href="#" class="text-gray-400 hover:text-white transition-custom">
            <i class="fa fa-envelope text-xl"></i>
          </a>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
        &copy; 2025 MD to Word Converter. All rights reserved.
      </div>
    </div>
  </footer>
  
  <!-- Help Modal -->
  <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">How to Use</h2>
        <button id="close-help" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-700">1. Upload Your Files or Folders</h3>
          <p class="text-gray-600">Drag and drop your Markdown files or entire folders into the upload area. You can also click "Choose Files" or "Choose Folder" to browse from your computer.</p>
          <p class="text-gray-600 mt-1">For files with images, it's best to upload the entire folder containing both the Markdown files and images.</p>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-700">2. Configure Conversion Options</h3>
          <p class="text-gray-600">Select a template and adjust the format options according to your preferences.</p>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-700">3. Preview Your Content</h3>
          <p class="text-gray-600">Review the Markdown or HTML preview to ensure everything looks correct before conversion.</p>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-700">4. Convert and Download</h3>
          <p class="text-gray-600">Click "Convert to Word" to start the conversion process. Once completed, download your Word documents.</p>
        </div>
        <div class="bg-light p-4 rounded-lg">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Supported Markdown Features</h3>
          <ul class="list-disc list-inside text-gray-600 space-y-1">
            <li>Headings (H1-H6)</li>
            <li>Bold and Italic text</li>
            <li>Lists (ordered and unordered)</li>
            <li>Links and Images</li>
            <li>Tables</li>
            <li>Code blocks and inline code</li>
            <li>Blockquotes</li>
            <li>Horizontal rules</li>
          </ul>
        </div>
      </div>
      <div class="mt-6 text-center">
        <button id="close-help-btn" class="btn bg-secondary hover:bg-primary text-white px-6 py-2 rounded-lg">
          Got it!
        </button>
      </div>
    </div>
  </div>

  <!-- Success Notification -->
  <div id="notification" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
    <i class="fa fa-check-circle mr-2"></i>
    <span id="notification-message">Conversion successful!</span>
  </div>

  <!-- Required Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/matlab.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
  
  <!-- Application Script -->
  <script>
    // Initialize markdown-it with math support
    const md = window.markdownit({
      html: true,
      linkify: true,
      typographer: true,
      highlight: function (str, lang) {
        if (lang && lang === 'matlab') {
          try {
            return '<pre class="hljs"><code>' +
                   hljs.highlight(str, { language: 'matlab' }).value +
                   '</code></pre>';
          } catch (__) {}
        }
        return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
      }
    });
    
    // DOM Elements
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const folderInput = document.getElementById('folder-input'); // 新增文件夹输入元素
    const filesContainer = document.getElementById('files-container');
    const filesList = document.getElementById('files-list');
    const convertBtn = document.getElementById('convert-btn');
    const markdownEditor = document.getElementById('markdown-editor');
    const markdownPreview = document.getElementById('markdown-preview');
    const htmlPreview = document.getElementById('html-preview');
    const mdEditorTextarea = document.getElementById('md-editor-textarea');
    const editorViewBtn = document.getElementById('editor-view-btn');
    const markdownViewBtn = document.getElementById('markdown-view-btn');
    const htmlViewBtn = document.getElementById('html-view-btn');
    const resultsContainer = document.getElementById('results-container');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const resultsList = document.getElementById('results-list');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeHelp = document.getElementById('close-help');
    const closeHelpBtn = document.getElementById('close-help-btn');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    const themeToggle = document.getElementById('theme-toggle');
    const templateOptions = document.querySelectorAll('.template-option');
    
    // State
    let uploadedFiles = [];
    let currentPreviewFile = null;
    let isDarkMode = false;
    let isEditorMode = false;
    let editorContent = '';
    let fileMap = new Map(); // 新增：存储所有文件的映射表，用于处理图片
    
    // Initialize the application
    function init() {
      setupEventListeners();
      convertBtn.disabled = true;
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Dropzone events
      dropzone.addEventListener('click', () => fileInput.click());
      dropzone.addEventListener('dragover', handleDragOver);
      dropzone.addEventListener('dragleave', handleDragLeave);
      dropzone.addEventListener('drop', handleDrop);
      
      // File input change
      fileInput.addEventListener('change', (e) => handleFileSelect(e, false));
      
      // 新增：文件夹输入事件
      folderInput.addEventListener('change', (e) => handleFileSelect(e, true));
      
      // View toggle buttons
      editorViewBtn.addEventListener('click', () => switchPreview('editor'));
      markdownViewBtn.addEventListener('click', () => switchPreview('markdown'));
      htmlViewBtn.addEventListener('click', () => switchPreview('html'));
      
      // Editor content change
      mdEditorTextarea.addEventListener('input', handleEditorInput);
      
      // Convert button
      convertBtn.addEventListener('click', convertFiles);
      
      // Help modal
      helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
      closeHelp.addEventListener('click', () => helpModal.classList.add('hidden'));
      closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
      
      // Theme toggle
      themeToggle.addEventListener('click', toggleTheme);
      
      // Template selection
      templateOptions.forEach(option => {
        option.addEventListener('click', () => {
          templateOptions.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
        });
      });
    }
    
    // Handle drag over event
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.add('active');
    }
    
    // Handle drag leave event
    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('active');
    }
    
    // Handle drop event
    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('active');
      
      if (e.dataTransfer.files.length) {
        // 检查是否是文件夹
        const isFolder = e.dataTransfer.files[0].webkitRelativePath !== '';
        processFiles(e.dataTransfer.files, isFolder);
      }
    }
    
    // Handle file selection (支持文件和文件夹)
    function handleFileSelect(e, isFolder) {
      if (e.target.files.length) {
        processFiles(e.target.files, isFolder);
      }
    }
    
    // 辅助函数：判断是否为Markdown文件
    function isMarkdownFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      return ['md', 'markdown', 'txt'].includes(ext);
    }
    
    // 辅助函数：判断是否为图片文件
    function isImageFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext);
    }
    
    // 辅助函数：标准化文件路径
    function normalizePath(path) {
      // 处理不同操作系统的路径分隔符
      return path.replace(/[\\/]/g, '/').toLowerCase();
    }
    
    // Process uploaded files (修改为支持文件夹)
    function processFiles(files, isFolder = false) {
      // 重置文件映射
      fileMap = new Map();
      
      // 首先收集所有文件信息
      Array.from(files).forEach(file => {
        // 对于文件夹上传，使用相对路径作为键
        const key = isFolder ? file.webkitRelativePath : file.name;
        fileMap.set(key, file);
      });
      
      // 筛选Markdown文件
      const markdownFiles = Array.from(files).filter(file => isMarkdownFile(file));
      
      if (markdownFiles.length === 0) {
        showNotification('Please select valid Markdown files (.md, .markdown, .txt)', 'error');
        return;
      }
      
      // 添加Markdown文件到列表
      markdownFiles.forEach(file => {
        // 检查文件是否已存在
        if (uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
          return;
        }
        
        uploadedFiles.push(file);
        
        // 创建文件项元素
        const fileItem = document.createElement('li');
        const path = isFolder ? file.webkitRelativePath : file.name;
        const displayName = path.split('/').pop();
        
        fileItem.className = 'file-item markdown flex items-center justify-between bg-gray-50 p-3 rounded-lg';
        fileItem.innerHTML = `
          <div class="flex items-center">
            <i class="fa fa-file-text-o text-secondary mr-3"></i>
            <div>
              <p class="font-medium text-gray-800 truncate max-w-[200px]" title="${path}">${displayName}</p>
              <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
            </div>
          </div>
          <div class="flex items-center">
            <button class="preview-file-btn p-1 text-gray-500 hover:text-secondary transition-custom" data-index="${uploadedFiles.length - 1}">
              <i class="fa fa-eye"></i>
            </button>
            <button class="remove-file-btn p-1 text-gray-500 hover:text-red-500 transition-custom ml-2" data-index="${uploadedFiles.length - 1}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        
        filesList.appendChild(fileItem);
        
        // 为按钮添加事件监听
        const previewBtn = fileItem.querySelector('.preview-file-btn');
        const removeBtn = fileItem.querySelector('.remove-file-btn');
        
        previewBtn.addEventListener('click', () => previewFile(parseInt(previewBtn.dataset.index), isFolder));
        removeBtn.addEventListener('click', () => removeFile(parseInt(removeBtn.dataset.index)));
      });
      
      // 显示文件容器
      filesContainer.classList.remove('hidden');
      
      // 如果有文件则启用转换按钮
      convertBtn.disabled = uploadedFiles.length === 0;
      
      // 如果当前没有预览文件且有上传的文件，则预览第一个文件
      if (!currentPreviewFile && uploadedFiles.length > 0) {
        previewFile(0, isFolder);
      }
      
      showNotification(`Successfully uploaded ${markdownFiles.length} file(s)`);
    }
    
    // Preview a file (修改为支持图片处理)
    function previewFile(index, isFolder = false) {
      if (index < 0 || index >= uploadedFiles.length) return;
      
      const file = uploadedFiles[index];
      currentPreviewFile = index;
      
      // 高亮选中的文件
      document.querySelectorAll('#files-list li').forEach((item, i) => {
        if (i === index) {
          item.classList.add('bg-light');
        } else {
          item.classList.remove('bg-light');
        }
      });
      
      const reader = new FileReader();
      reader.onload = function(e) {
        let content = e.target.result;
        editorContent = content;
        mdEditorTextarea.value = content;
        
        // 处理图片路径
        if (isFolder && fileMap.size > 0) {
          // 正则匹配Markdown图片语法: ![alt](path)
          content = content.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, path) => {
            const normalizedPath = normalizePath(path);
            
            // 在fileMap中查找匹配的图片文件
            for (const key of fileMap.keys()) {
              if (key.endsWith(normalizedPath) || normalizePath(key) === normalizedPath) {
                const imageFile = fileMap.get(key);
                const imageReader = new FileReader();
                
                imageReader.onload = function(imgEvent) {
                  // 更新预览内容中的图片路径为dataURL
                  const updatedContent = mdEditorTextarea.value.replace(path, imgEvent.target.result);
                  mdEditorTextarea.value = updatedContent;
                  handleEditorInput();
                };
                
                imageReader.readAsDataURL(imageFile);
                return match; // 临时返回原匹配，稍后会更新
              }
            }
            
            return match; // 未找到图片则保持原样
          });
        }
        
        // 更新Markdown预览
        markdownPreview.innerHTML = `<pre class="whitespace-pre-wrap">${content}</pre>`;
        
        // 处理MATLAB代码块的公式转换
        const processedContent = processMatlabContent(content);
        
        // 更新HTML预览
        const htmlContent = md.render(processedContent);
        htmlPreview.innerHTML = htmlContent;
        
        // 使用MathJax渲染数学公式
        if (window.MathJax) {
          MathJax.typesetPromise([htmlPreview]).catch(console.error);
        }
        
        // 默认切换到markdown视图
        switchPreview('markdown');
      };
      
      reader.readAsText(file);
    }
    
    // Remove a file
    function removeFile(index) {
      if (index < 0 || index >= uploadedFiles.length) return;
      
      // 从数组中移除
      uploadedFiles.splice(index, 1);
      
      // 从DOM中移除
      filesList.removeChild(filesList.children[index]);
      
      // 更新剩余文件项的索引
      Array.from(filesList.children).forEach((item, i) => {
        const previewBtn = item.querySelector('.preview-file-btn');
        const removeBtn = item.querySelector('.remove-file-btn');
        previewBtn.dataset.index = i;
        removeBtn.dataset.index = i;
      });
      
      // 如果没有文件了，隐藏文件容器
      if (uploadedFiles.length === 0) {
        filesContainer.classList.add('hidden');
        convertBtn.disabled = true;
        
        // 清空预览
        markdownPreview.innerHTML = `
          <div class="flex items-center justify-center h-full text-gray-500">
            <div class="text-center">
              <i class="fa fa-file-text-o text-4xl mb-3"></i>
              <p>Upload a file to see preview</p>
            </div>
          </div>
        `;
        
        htmlPreview.innerHTML = `
          <div class="flex items-center justify-center h-full text-gray-500">
            <div class="text-center">
              <i class="fa fa-code text-4xl mb-3"></i>
              <p>Upload a file to see HTML preview</p>
            </div>
          </div>
        `;
        
        currentPreviewFile = null;
        fileMap.clear(); // 清空文件映射
      } else if (currentPreviewFile === index) {
        // 如果当前预览的文件被删除，预览第一个文件
        previewFile(0);
      } else if (currentPreviewFile > index) {
        // 必要时调整当前预览索引
        currentPreviewFile--;
      }
      
      showNotification('File removed');
    }
    
    // Switch preview between Editor, Markdown and HTML
    function switchPreview(view) {
      if (view === 'editor') {
        // 显示编辑器，隐藏其他
        markdownEditor.classList.remove('hidden');
        markdownPreview.classList.add('hidden');
        htmlPreview.classList.add('hidden');
        
        // 更新按钮样式
        editorViewBtn.classList.add('bg-light', 'text-secondary');
        editorViewBtn.classList.remove('text-gray-600');
        markdownViewBtn.classList.remove('bg-light', 'text-secondary');
        markdownViewBtn.classList.add('text-gray-600');
        htmlViewBtn.classList.remove('bg-light', 'text-secondary');
        htmlViewBtn.classList.add('text-gray-600');
        
        isEditorMode = true;
        convertBtn.disabled = false;
      } else if (view === 'markdown') {
        // 显示markdown预览，隐藏其他
        markdownEditor.classList.add('hidden');
        markdownPreview.classList.remove('hidden');
        htmlPreview.classList.add('hidden');
        
        // 更新按钮样式
        editorViewBtn.classList.remove('bg-light', 'text-secondary');
        editorViewBtn.classList.add('text-gray-600');
        markdownViewBtn.classList.add('bg-light', 'text-secondary');
        markdownViewBtn.classList.remove('text-gray-600');
        htmlViewBtn.classList.remove('bg-light', 'text-secondary');
        htmlViewBtn.classList.add('text-gray-600');
        
        isEditorMode = false;
        
        // 如果在编辑模式，更新markdown预览
        if (editorContent) {
          markdownPreview.innerHTML = `<pre class="whitespace-pre-wrap">${editorContent}</pre>`;
        }
      } else {
        // 显示HTML预览，隐藏其他
        markdownEditor.classList.add('hidden');
        markdownPreview.classList.add('hidden');
        htmlPreview.classList.remove('hidden');
        
        // 更新按钮样式
        editorViewBtn.classList.remove('bg-light', 'text-secondary');
        editorViewBtn.classList.add('text-gray-600');
        markdownViewBtn.classList.remove('bg-light', 'text-secondary');
        markdownViewBtn.classList.add('text-gray-600');
        htmlViewBtn.classList.add('bg-light', 'text-secondary');
        htmlViewBtn.classList.remove('text-gray-600');
        
        isEditorMode = false;
        
        // 如果在编辑模式，更新HTML预览
        if (editorContent) {
          const htmlContent = md.render(editorContent);
          htmlPreview.innerHTML = htmlContent;
        }
      }
    }
    
    // Convert MATLAB code to LaTeX formula
    function convertMatlabToLatex(matlabCode) {
      // Simple conversion rules for common MATLAB syntax to LaTeX
      let latex = matlabCode
        // Replace MATLAB operators with LaTeX equivalents
        .replace(/\^/g, '^')
        .replace(/\*/g, ' \\cdot ')
        .replace(/\//g, ' / ')
        .replace(/\+/g, ' + ')
        .replace(/-/g, ' - ')
        
        // Replace common MATLAB functions with LaTeX equivalents
        .replace(/sin\(/g, '\\sin(')
        .replace(/cos\(/g, '\\cos(')
        .replace(/tan\(/g, '\\tan(')
        .replace(/sqrt\(/g, '\\sqrt(')
        .replace(/exp\(/g, 'e^{')
        .replace(/\)/g, ')')
        .replace(/log\(/g, '\\log(')
        .replace(/abs\(/g, '|')
        .replace(/\)/g, '|')
        
        // Replace MATLAB matrix notation with LaTeX matrix
        .replace(/\[([^\]]+)\]/g, function(match, content) {
          // Simple matrix conversion
          let rows = content.split(';').map(row => 
            row.trim().replace(/\s+/g, '&')
          ).join('\\\\');
          return '\\begin{pmatrix}' + rows + '\\end{pmatrix}';
        })
        
        // Replace MATLAB variable names with LaTeX math mode
        .replace(/([a-zA-Z_][a-zA-Z0-9_]*)/g, ' $1 ')
        
        // Clean up extra spaces
        .replace(/\s+/g, ' ')
        .trim();
      
      return latex;
    }
    
    // Process content for MATLAB to LaTeX conversion
    function processMatlabContent(content) {
      // Look for MATLAB code blocks with a special comment indicating formula conversion
      return content.replace(/```matlab\s*%.*?formula.*?\n([\s\S]*?)```/g, function(match, code) {
        const latex = convertMatlabToLatex(code);
        return `$$${latex}$$`;
      });
    }
    
    // Handle editor input
    function handleEditorInput() {
      editorContent = mdEditorTextarea.value;
      
      // Process MATLAB code blocks for formula conversion
      const processedContent = processMatlabContent(editorContent);
      
      // 如果预览可见则更新
      if (!markdownPreview.classList.contains('hidden')) {
        markdownPreview.innerHTML = `<pre class="whitespace-pre-wrap">${editorContent}</pre>`;
      }
      
      if (!htmlPreview.classList.contains('hidden')) {
        const htmlContent = md.render(processedContent);
        htmlPreview.innerHTML = htmlContent;
        
        // 使用MathJax渲染数学公式
        if (window.MathJax) {
          MathJax.typesetPromise([htmlPreview]).catch(console.error);
        }
      }
      
      // 如果有内容则启用转换按钮
      convertBtn.disabled = !editorContent.trim() && uploadedFiles.length === 0;
    }
    
    // Convert files to Word (修改为支持图片嵌入)
    async function convertFiles() {
      // 处理编辑器内容转换
      if (isEditorMode && editorContent) {
        // 显示结果容器和进度条
        resultsContainer.classList.remove('hidden');
        progressContainer.classList.remove('hidden');
        
        // 重置进度
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        
        // 滚动到结果区域
        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // 清除之前的结果
        resultsList.innerHTML = '';
        
        // 获取选中的模板
        const selectedTemplate = document.querySelector('.template-option.selected').textContent.trim().toLowerCase().includes('professional') ? 'professional' : 'standard';
        
        // 获取格式选项
        const includeToc = document.querySelectorAll('input[type="checkbox"]')[1].checked;
        
        // 模拟进度
        let progress = 0;
        const interval = setInterval(() => {
          progress += 5;
          progressBar.style.width = `${progress}%`;
          progressPercentage.textContent = `${progress}%`;
          
          if (progress >= 100) {
            clearInterval(interval);
            
            setTimeout(() => {
              progressContainer.classList.add('hidden');
            }, 500);
          }
        }, 100);
        
        try {
          // 处理MATLAB代码块的公式转换
          let processedContent = processMatlabContent(editorContent);
          
          // 处理图片（如果有文件夹上传）
          if (fileMap.size > 0) {
            // 替换图片路径为dataURL
            const promises = [];
            const matches = processedContent.match(/!\[(.*?)\]\((.*?)\)/g) || [];
            
            matches.forEach(match => {
              const pathMatch = match.match(/!\[(.*?)\]\((.*?)\)/);
              if (pathMatch && pathMatch[2]) {
                const path = pathMatch[2];
                const normalizedPath = normalizePath(path);
                
                // 查找匹配的图片文件
                for (const key of fileMap.keys()) {
                  if (key.endsWith(normalizedPath) || normalizePath(key) === normalizedPath) {
                    const imageFile = fileMap.get(key);
                    const promise = new Promise(resolveImg => {
                      const imageReader = new FileReader();
                      imageReader.onload = function(imgEvent) {
                        processedContent = processedContent.replace(path, imgEvent.target.result);
                        resolveImg();
                      };
                      imageReader.readAsDataURL(imageFile);
                    });
                    promises.push(promise);
                    break;
                  }
                }
              }
            });
            
            // 等待所有图片处理完成
            await Promise.all(promises);
          }
          
          // 转换为HTML
          const htmlContent = md.render(processedContent);
          const styledHtml = createStyledHtml(htmlContent, selectedTemplate, includeToc);
          const blob = htmlDocx.asBlob(styledHtml);
          
          // 创建结果项
          const resultItem = document.createElement('div');
          resultItem.className = 'bg-gray-50 p-4 rounded-lg flex items-center justify-between';
          resultItem.innerHTML = `
            <div class="flex items-center">
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                <i class="fa fa-check text-green-500"></i>
              </div>
              <div>
                <p class="font-medium text-gray-800">document.docx</p>
                <p class="text-xs text-gray-500">${formatFileSize(blob.size)}</p>
              </div>
            </div>
            <button class="download-btn bg-secondary hover:bg-primary text-white px-4 py-2 rounded-lg transition-custom">
              <i class="fa fa-download mr-1"></i> Download
            </button>
          `;
          
          resultsList.appendChild(resultItem);
          
          // 添加下载事件
          const downloadBtn = resultItem.querySelector('.download-btn');
          downloadBtn.addEventListener('click', () => {
            saveAs(blob, 'document.docx');
            showNotification('File downloaded successfully');
          });
          
          showNotification('Conversion completed!');
          
        } catch (error) {
          console.error('Conversion error:', error);
          
          // 创建错误结果项
          const resultItem = document.createElement('div');
          resultItem.className = 'bg-gray-50 p-4 rounded-lg flex items-center justify-between';
          resultItem.innerHTML = `
            <div class="flex items-center">
              <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                <i class="fa fa-times text-red-500"></i>
              </div>
              <div>
                <p class="font-medium text-gray-800">document.docx</p>
                <p class="text-xs text-red-500">Conversion failed</p>
              </div>
            </div>
            <button class="retry-btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-custom">
              <i class="fa fa-refresh mr-1"></i> Retry
            </button>
          `;
          
          resultsList.appendChild(resultItem);
          
          // 添加重试事件
          const retryBtn = resultItem.querySelector('.retry-btn');
          retryBtn.addEventListener('click', () => {
            // 移除该结果
            resultsList.removeChild(resultItem);
            
            // 重新处理
            convertFiles();
          });
        }
        
        return;
      }
      
      if (uploadedFiles.length === 0) return;
      
      // 显示结果容器和进度条
      resultsContainer.classList.remove('hidden');
      progressContainer.classList.remove('hidden');
      
      // 重置进度
      progressBar.style.width = '0%';
      progressPercentage.textContent = '0%';
      
      // 滚动到结果区域
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // 清除之前的结果
      resultsList.innerHTML = '';
      
      // 获取选中的模板
      const selectedTemplate = document.querySelector('.template-option.selected').textContent.trim().toLowerCase().includes('professional') ? 'professional' : 'standard';
      
      // 获取格式选项
      const preserveFormatting = document.querySelector('input[type="checkbox"]').checked;
      const includeToc = document.querySelectorAll('input[type="checkbox"]')[1].checked;
      
      // 处理每个文件
      for (let i = 0; i < uploadedFiles.length; i++) {
        const file = uploadedFiles[i];
        const reader = new FileReader();
        
        await new Promise(resolve => {
          reader.onload = async function(e) {
            let content = e.target.result;
            
            // 处理图片
            if (fileMap.size > 0) {
              // 使用正则替换图片路径为dataURL
              const promises = [];
              const matches = content.match(/!\[(.*?)\]\((.*?)\)/g) || [];
              
              matches.forEach(match => {
                const pathMatch = match.match(/!\[(.*?)\]\((.*?)\)/);
                if (pathMatch && pathMatch[2]) {
                  const path = pathMatch[2];
                  const normalizedPath = normalizePath(path);
                  
                  // 查找匹配的图片文件
                  for (const key of fileMap.keys()) {
                    if (key.endsWith(normalizedPath) || normalizePath(key) === normalizedPath) {
                      const imageFile = fileMap.get(key);
                      const promise = new Promise(resolveImg => {
                        const imageReader = new FileReader();
                        imageReader.onload = function(imgEvent) {
                          content = content.replace(path, imgEvent.target.result);
                          resolveImg();
                        };
                        imageReader.readAsDataURL(imageFile);
                      });
                      promises.push(promise);
                      break;
                    }
                  }
                }
              });
              
              // 等待所有图片处理完成
              await Promise.all(promises);
            }
            
            // 处理MATLAB代码块的公式转换
            const processedContent = processMatlabContent(content);
            
            // 转换为HTML
            const htmlContent = md.render(processedContent);
            const styledHtml = createStyledHtml(htmlContent, selectedTemplate, includeToc);
            
            // 转换为Word文档
            const blob = htmlDocx.asBlob(styledHtml);
            
            // 创建结果项
            const resultItem = document.createElement('div');
            resultItem.className = 'bg-gray-50 p-4 rounded-lg flex items-center justify-between';
            
            // 获取文件名（不含扩展名）
            const fileName = file.name.replace(/\.(md|markdown|txt)$/i, '');
            
            resultItem.innerHTML = `
              <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                  <i class="fa fa-check text-green-500"></i>
                </div>
                <div>
                  <p class="font-medium text-gray-800">${fileName}.docx</p>
                  <p class="text-xs text-gray-500">${formatFileSize(blob.size)}</p>
                </div>
              </div>
              <button class="download-btn bg-secondary hover:bg-primary text-white px-4 py-2 rounded-lg transition-custom">
                <i class="fa fa-download mr-1"></i> Download
              </button>
            `;
            
            resultsList.appendChild(resultItem);
            
            // 添加下载事件
            const downloadBtn = resultItem.querySelector('.download-btn');
            downloadBtn.addEventListener('click', () => {
              saveAs(blob, `${fileName}.docx`);
              showNotification('File downloaded successfully');
            });
            
            resolve();
          };
          
          reader.readAsText(file);
        });
        
        // 更新进度
        updateProgress(((i + 1) / uploadedFiles.length) * 100);
      }
      
      // 隐藏进度条
      setTimeout(() => {
        progressContainer.classList.add('hidden');
      }, 500);
      
      showNotification('All files converted successfully!');
    }
    
    // Update progress bar
    function updateProgress(percentage) {
      progressBar.style.width = `${percentage}%`;
      progressPercentage.textContent = `${Math.round(percentage)}%`;
    }
    
    // Format file size for display
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // Show notification
    function showNotification(message, type = 'success') {
      notificationMessage.textContent = message;
      
      // Set notification color based on type
      if (type === 'error') {
        notification.classList.remove('bg-green-500');
        notification.classList.add('bg-red-500');
      } else {
        notification.classList.remove('bg-red-500');
        notification.classList.add('bg-green-500');
      }
      
      // Show notification
      notification.classList.remove('translate-y-20', 'opacity-0');
      
      // Hide after 3 seconds
      setTimeout(() => {
        notification.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }
    
    // Toggle dark/light theme
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('bg-gray-900');
      document.body.classList.toggle('bg-gray-50');
      
      const themeIcon = themeToggle.querySelector('i');
      if (isDarkMode) {
        themeIcon.classList.remove('fa-moon-o');
        themeIcon.classList.add('fa-sun-o');
      } else {
        themeIcon.classList.remove('fa-sun-o');
        themeIcon.classList.add('fa-moon-o');
      }
      
      // Add more theme toggling logic as needed
    }
    
    // Create styled HTML for Word document
    function createStyledHtml(content, template = 'standard', includeToc = false) {
      // Base styles
      let styles = `
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
          h1, h2, h3, h4, h5, h6 { color: #1e40af; margin-top: 1.5em; margin-bottom: 0.5em; }
          h1 { border-bottom: 2px solid #3b82f6; padding-bottom: 0.3em; }
          h2 { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
          p { margin-top: 0; margin-bottom: 1em; }
          ul, ol { margin-top: 0; margin-bottom: 1em; padding-left: 2em; }
          a { color: #3b82f6; text-decoration: none; }
          a:hover { text-decoration: underline; }
          pre { background-color: #f3f4f6; padding: 1em; border-radius: 4px; overflow-x: auto; margin-bottom: 1em; }
          code { font-family: Consolas, monospace; font-size: 0.9em; }
          blockquote { border-left: 4px solid #3b82f6; padding-left: 1em; margin-left: 0; color: #6b7280; }
          table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
          th, td { border: 1px solid #e5e7eb; padding: 0.5em 1em; text-align: left; }
          th { background-color: #eff6ff; }
          img { max-width: 100%; height: auto; margin: 1em 0; }
        </style>
      `;
      
      // Professional template styles
      if (template === 'professional') {
        styles = `
          <style>
            body { font-family: 'Times New Roman', Times, serif; line-height: 1.8; color: #222; max-width: 900px; margin: 0 auto; padding: 40px; }
            h1, h2, h3, h4, h5, h6 { color: #1e3a8a; font-weight: bold; margin-top: 2em; margin-bottom: 1em; }
            h1 { font-size: 2em; text-align: center; margin-bottom: 1.5em; }
            h2 { font-size: 1.5em; border-bottom: 1px solid #1e3a8a; padding-bottom: 0.3em; }
            p { margin-top: 0; margin-bottom: 1.5em; text-align: justify; }
            ul, ol { margin-top: 0; margin-bottom: 1.5em; padding-left: 2.5em; }
            a { color: #1e40af; text-decoration: underline; }
            pre { background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1em; border-radius: 2px; overflow-x: auto; margin-bottom: 1.5em; }
            code { font-family: 'Courier New', monospace; font-size: 0.9em; }
            blockquote { border-left: 3px solid #1e40af; padding-left: 1.5em; margin-left: 0; margin-bottom: 1.5em; font-style: italic; }
            table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; }
            th, td { border: 1px solid #cbd5e1; padding: 0.7em 1.2em; text-align: left; }
            th { background-color: #eff6ff; font-weight: bold; }
            img { max-width: 100%; height: auto; margin: 2em auto; display: block; }
            .toc { margin: 2em 0 3em 0; padding: 1em; border: 1px solid #e2e8f0; }
            .toc-title { font-weight: bold; margin-bottom: 0.5em; font-size: 1.2em; }
          </style>
        `;
      }
      
      // Generate table of contents if needed
      let toc = '';
      if (includeToc) {
        toc = '<div class="toc"><p class="toc-title">Table of Contents</p><ul>';
        
        // Simple TOC generation - would need more sophisticated parsing for production use
        const headings = content.match(/<h[1-6][^>]*>(.*?)<\/h[1-6]>/gi) || [];
        headings.forEach(heading => {
          const level = heading.match(/<h([1-6])/)[1];
          const text = heading.replace(/<\/?h[1-6][^>]*>/g, '');
          const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          
          toc += `<li style="margin-left: ${(level - 1) * 15}px;"><a href="#${id}">${text}</a></li>`;
          
          // Add ID to heading for anchor links
          content = content.replace(heading, heading.replace(/<h([1-6])/, `<h$1 id="${id}"`));
        });
        
        toc += '</ul></div>';
      }
      
      // Return complete HTML document
      return `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8">
            ${styles}
          </head>
          <body>
            ${toc}
            ${content}
          </body>
        </html>
      `;
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
